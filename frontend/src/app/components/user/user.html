<div class="page-wrapper">
  <!-- Header -->
  <header class="header user-header">
    <div class="header-brand">
      <span class="brand-icon">üìù</span>
      <span class="brand-name">AMRSP Portal</span>
    </div>
    <div class="header-right">
      <app-health-status />
      <span class="welcome-text">Welcome, {{ auth.currentUser() }}</span>
      <button class="btn-logout" (click)="auth.logout()">Logout</button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Hero -->
    <div class="hero-card user-hero">
      <h2>Research Submission</h2>
      <p>
        Upload your PDF research paper and let AMRSP automatically extract, analyse and index it
        through our AI-powered pipeline.
      </p>
    </div>

    <!-- Upload + Pipeline -->
    <div class="submission-layout">
      <!-- LEFT: Upload zone -->
      <section class="upload-panel">
        <h3 class="panel-title">üìÑ Upload Document</h3>

        <!-- Drop zone -->
        @if (uploadStatus() === 'idle' || uploadStatus() === 'processing') {
          <div
            class="drop-zone"
            [class.drag-over]="isDragOver()"
            [class.has-file]="selectedFile()"
            (dragover)="onDragOver($event)"
            (dragleave)="onDragLeave()"
            (drop)="onDrop($event)"
            (click)="fileInput.click()"
          >
            <input
              #fileInput
              type="file"
              accept=".pdf,application/pdf"
              style="display: none"
              (change)="onFileSelected($event)"
            />

            @if (!selectedFile()) {
              <div class="drop-zone-empty">
                <div class="drop-icon">üìÇ</div>
                <p class="drop-primary">Drag &amp; drop your PDF here</p>
                <p class="drop-secondary">or click to browse</p>
                <span class="drop-hint">Accepts PDF files only</span>
              </div>
            } @else {
              <div class="file-info">
                <div class="file-icon">üìë</div>
                <div class="file-meta">
                  <span class="file-name">{{ selectedFile()!.name }}</span>
                  <span class="file-size">{{ formatFileSize(selectedFile()!.size) }}</span>
                </div>
                @if (uploadStatus() === 'idle') {
                  <button class="btn-clear" (click)="$event.stopPropagation(); reset()">‚úï</button>
                }
              </div>
            }
          </div>
        }

        <!-- Done state -->
        @if (uploadStatus() === 'done') {
          <div class="result-box success">
            <div class="result-icon">‚úÖ</div>
            <div>
              <p class="result-title">Processing Complete!</p>
              <p class="result-sub">
                {{ selectedFile()!.name }} has been fully processed and indexed.
              </p>
              @if (totalElapsedMs() !== null) {
                <p class="elapsed-time">Total pipeline time: {{ totalElapsedMs() }}ms</p>
              }
            </div>
          </div>
        }

        <!-- Error state -->
        @if (uploadStatus() === 'error' && apiError()) {
          <div class="api-error-box">‚ö†Ô∏è {{ apiError() }}</div>
        }

        <!-- Upload button -->
        <button
          class="btn-upload"
          [disabled]="!selectedFile() || uploadStatus() === 'processing'"
          [class.processing]="uploadStatus() === 'processing'"
          [class.done]="uploadStatus() === 'done'"
          (click)="
            uploadStatus() === 'done' || uploadStatus() === 'error' ? reset() : startProcessing()
          "
        >
          @if (uploadStatus() === 'idle') {
            <span>üöÄ Upload &amp; Process</span>
          } @else if (uploadStatus() === 'processing') {
            <span class="btn-spinner"></span>
            <span>Processing‚Ä¶</span>
          } @else if (uploadStatus() === 'done') {
            <span>üîÑ Upload Another</span>
          } @else if (uploadStatus() === 'error') {
            <span>üîÑ Try Again</span>
          }
        </button>

        <!-- Progress bar -->
        @if (uploadStatus() === 'processing' || uploadStatus() === 'done') {
          <div class="progress-bar-wrap">
            <div class="progress-bar-track">
              <div class="progress-bar-fill" [style.width.%]="progressPercent()"></div>
            </div>
            <span class="progress-label">{{ progressPercent() }}%</span>
          </div>
        }
      </section>

      <!-- RIGHT: Pipeline Steps -->
      <section class="pipeline-panel">
        <h3 class="panel-title">‚öôÔ∏è Processing Pipeline</h3>
        <p class="pipeline-subtitle">
          Each uploaded document is automatically run through the following AI pipeline:
        </p>

        <ol class="pipeline-steps">
          @for (step of steps(); track step.id) {
            <li class="pipeline-step" [class]="step.state">
              <div class="step-indicator">
                @if (step.state === 'done') {
                  <span class="step-check">‚úì</span>
                } @else if (step.state === 'error') {
                  <span class="step-check">‚úï</span>
                } @else if (step.state === 'active') {
                  <span class="step-spinner"></span>
                } @else {
                  <span class="step-num">{{ step.id }}</span>
                }
              </div>
              <div class="step-body">
                <div class="step-header">
                  <span class="step-icon">{{ step.icon }}</span>
                  <span class="step-title">{{ step.title }}</span>
                  @if (step.state === 'done') {
                    <span class="step-badge done">Done</span>
                  } @else if (step.state === 'active') {
                    <span class="step-badge active">Running</span>
                  } @else if (step.state === 'error') {
                    <span class="step-badge error">Failed</span>
                  }
                </div>
                <p class="step-desc">{{ step.description }}</p>
                @if (step.state === 'error' && step.detail) {
                  <p class="step-detail">{{ step.detail }}</p>
                }
              </div>
            </li>
          }
        </ol>
      </section>
    </div>

    <!-- ‚îÄ‚îÄ My Submissions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <section class="my-submissions">
      <div class="submissions-header">
        <div>
          <h3 class="panel-title">&#128196; My Submissions</h3>
          <p class="submissions-subtitle">Track your uploaded documents and their review status.</p>
        </div>
        <button
          class="btn-refresh-subs"
          (click)="loadMySubmissions()"
          [disabled]="submissionsLoading()"
        >
          &#8635; Refresh
        </button>
      </div>

      @if (submissionsLoading()) {
        <div class="subs-empty">Loading your submissions&hellip;</div>
      } @else if (mySubmissions().length === 0) {
        <div class="subs-empty">No submissions yet. Upload a document above to get started.</div>
      } @else {
        <div class="subs-table-wrap">
          <table class="subs-table">
            <thead>
              <tr>
                <th>File</th>
                <th>Submitted</th>
                <th>Pipeline</th>
                <th>Review Status</th>
                <th>Note</th>
              </tr>
            </thead>
            <tbody>
              @for (doc of mySubmissions(); track doc.documentId) {
                <tr>
                  <td class="subs-filename">&#128196; {{ doc.fileName }}</td>
                  <td class="subs-date">{{ doc.processedAt | date: 'mediumDate' }}</td>
                  <td>
                    <span
                      [class.sbadge-ok]="doc.overallSuccess"
                      [class.sbadge-warn]="!doc.overallSuccess"
                    >
                      {{ doc.overallSuccess ? '&#10003; OK' : '&#9888; Errors' }}
                    </span>
                  </td>
                  <td>
                    @switch (reviewStatusLabel(doc)) {
                      @case ('auto') {
                        <span class="sbadge-auto">&#9654; Auto-passed</span>
                      }
                      @case ('awaiting') {
                        <span class="sbadge-awaiting">&#9202; Awaiting Review</span>
                      }
                      @case ('approved') {
                        <span class="sbadge-approved">&#10003; Approved</span>
                      }
                      @case ('rejected') {
                        <span class="sbadge-rejected">&#10007; Rejected</span>
                      }
                    }
                  </td>
                  <td class="subs-note">
                    @if (doc.reviewDecision?.rejectionReason) {
                      <span class="rejection-note">{{ doc.reviewDecision!.rejectionReason }}</span>
                    } @else if (reviewStatusLabel(doc) === 'awaiting') {
                      <span class="muted">Pending admin decision</span>
                    } @else {
                      &ndash;
                    }
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }
    </section>
  </main>
</div>
