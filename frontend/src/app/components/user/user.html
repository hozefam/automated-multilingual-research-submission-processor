<div class="page-wrapper">
  <!-- Header -->
  <header class="header user-header">
    <div class="header-brand">
      <span class="brand-icon">ğŸ“</span>
      <span class="brand-name">AMRSP Portal</span>
    </div>
    <div class="header-right">
      <app-health-status />
      <span class="welcome-text">Welcome, {{ auth.currentUser() }}</span>
      <button class="btn-logout" (click)="auth.logout()">Logout</button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Hero -->
    <div class="hero-card user-hero">
      <h2>Research Submission</h2>
      <p>
        Upload your PDF research paper and let AMRSP automatically extract, analyse and index it
        through our AI-powered pipeline.
      </p>
    </div>

    <!-- Upload + Pipeline -->
    <div class="submission-layout">
      <!-- LEFT: Upload zone -->
      <section class="upload-panel">
        <h3 class="panel-title">ğŸ“„ Upload Document</h3>

        <!-- Drop zone -->
        @if (uploadStatus() === 'idle' || uploadStatus() === 'processing') {
          <div
            class="drop-zone"
            [class.drag-over]="isDragOver()"
            [class.has-file]="selectedFile()"
            (dragover)="onDragOver($event)"
            (dragleave)="onDragLeave()"
            (drop)="onDrop($event)"
            (click)="fileInput.click()"
          >
            <input
              #fileInput
              type="file"
              accept=".pdf,application/pdf"
              style="display: none"
              (change)="onFileSelected($event)"
            />

            @if (!selectedFile()) {
              <div class="drop-zone-empty">
                <div class="drop-icon">ğŸ“‚</div>
                <p class="drop-primary">Drag &amp; drop your PDF here</p>
                <p class="drop-secondary">or click to browse</p>
                <span class="drop-hint">Accepts PDF files only</span>
              </div>
            } @else {
              <div class="file-info">
                <div class="file-icon">ğŸ“‘</div>
                <div class="file-meta">
                  <span class="file-name">{{ selectedFile()!.name }}</span>
                  <span class="file-size">{{ formatFileSize(selectedFile()!.size) }}</span>
                </div>
                @if (uploadStatus() === 'idle') {
                  <button class="btn-clear" (click)="$event.stopPropagation(); reset()">âœ•</button>
                }
              </div>
            }
          </div>
        }

        <!-- Done state -->
        @if (uploadStatus() === 'done') {
          <div class="result-box success">
            <div class="result-icon">âœ…</div>
            <div>
              <p class="result-title">Processing Complete!</p>
              <p class="result-sub">
                {{ selectedFile()!.name }} has been fully processed and indexed.
              </p>
            </div>
          </div>
        }

        <!-- Upload button -->
        <button
          class="btn-upload"
          [disabled]="!selectedFile() || uploadStatus() === 'processing'"
          [class.processing]="uploadStatus() === 'processing'"
          [class.done]="uploadStatus() === 'done'"
          (click)="uploadStatus() === 'done' ? reset() : startProcessing()"
        >
          @if (uploadStatus() === 'idle') {
            <span>ğŸš€ Upload &amp; Process</span>
          } @else if (uploadStatus() === 'processing') {
            <span class="btn-spinner"></span>
            <span>Processingâ€¦</span>
          } @else if (uploadStatus() === 'done') {
            <span>ğŸ”„ Upload Another</span>
          }
        </button>

        <!-- Progress bar -->
        @if (uploadStatus() === 'processing' || uploadStatus() === 'done') {
          <div class="progress-bar-wrap">
            <div class="progress-bar-track">
              <div class="progress-bar-fill" [style.width.%]="progressPercent()"></div>
            </div>
            <span class="progress-label">{{ progressPercent() }}%</span>
          </div>
        }
      </section>

      <!-- RIGHT: Pipeline Steps -->
      <section class="pipeline-panel">
        <h3 class="panel-title">âš™ï¸ Processing Pipeline</h3>
        <p class="pipeline-subtitle">
          Each uploaded document is automatically run through the following AI pipeline:
        </p>

        <ol class="pipeline-steps">
          @for (step of steps(); track step.id) {
            <li class="pipeline-step" [class]="step.state">
              <div class="step-indicator">
                @if (step.state === 'done') {
                  <span class="step-check">âœ“</span>
                } @else if (step.state === 'active') {
                  <span class="step-spinner"></span>
                } @else {
                  <span class="step-num">{{ step.id }}</span>
                }
              </div>
              <div class="step-body">
                <div class="step-header">
                  <span class="step-icon">{{ step.icon }}</span>
                  <span class="step-title">{{ step.title }}</span>
                  @if (step.state === 'done') {
                    <span class="step-badge done">Done</span>
                  } @else if (step.state === 'active') {
                    <span class="step-badge active">Running</span>
                  }
                </div>
                <p class="step-desc">{{ step.description }}</p>
              </div>
            </li>
          }
        </ol>
      </section>
    </div>
  </main>
</div>
