<div class="page-wrapper">
  <!-- Header -->
  <header class="header admin-header">
    <div class="header-brand">
      <span class="brand-icon">&#128737;&#65039;</span>
      <span class="brand-name">AMRSP Admin Portal</span>
    </div>
    <div class="header-right">
      <app-health-status />
      <span class="welcome-text">Welcome, {{ auth.currentUser() }}</span>
      <button class="btn-logout" (click)="auth.logout()">Logout</button>
    </div>
  </header>

  <main class="main-content">

    <!-- Action message -->
    @if (actionMessage()) {
      <div
        class="alert"
        [class.alert-success]="actionMessage()!.type === 'success'"
        [class.alert-error]="actionMessage()!.type === 'error'"
      >
        {{ actionMessage()!.text }}
      </div>
    }

    <!-- Stats bar -->
    <div class="stats-bar">
      <div class="stat-card stat-pending">
        <div class="stat-count">{{ awaitingReview().length }}</div>
        <div class="stat-label">Awaiting Review</div>
      </div>
      <div class="stat-card stat-processed">
        <div class="stat-count">{{ processed().length }}</div>
        <div class="stat-label">Processed</div>
      </div>
      <div class="stat-card stat-total">
        <div class="stat-count">{{ documents().length }}</div>
        <div class="stat-label">Total</div>
      </div>
      <button class="btn-refresh" (click)="loadDocuments()" [disabled]="loading()">
        &#8635; Refresh
      </button>
    </div>

    <!-- ── Awaiting Review ──────────────────────────────────────────────── -->
    <section class="doc-section">
      <div class="section-header">
        <h2>&#128100; Awaiting Review</h2>
        <p>Documents flagged by the AI pipeline that require a manual Approve or Reject decision.</p>
      </div>

      @if (loading()) {
        <div class="empty-state">Loading...</div>
      } @else if (awaitingReview().length === 0) {
        <div class="empty-state">&#10003; No documents awaiting review.</div>
      }

      @for (doc of awaitingReview(); track doc.documentId) {
        <div class="review-card">
          <div class="review-header">
            <span class="review-doc">&#128196; {{ doc.fileName }}</span>
            <span class="review-id mono">{{ doc.documentId }}</span>
            <span class="review-confidence" [class.low]="doc.overallConfidence < 0.25">
              Confidence: {{ (doc.overallConfidence * 100).toFixed(0) }}%
            </span>
            <span class="review-date">{{ doc.processedAt | date: 'short' }}</span>
          </div>

          <!-- Flagged items -->
          @if (doc.flaggedItems.length > 0) {
            <div class="flagged-list">
              @for (item of doc.flaggedItems; track item.field) {
                <div class="flagged-chip">
                  <span class="chip-field">{{ item.field }}</span>
                  <span class="chip-detail">{{ item.agentResult }}</span>
                </div>
              }
            </div>
          }

          <!-- Approve / Reject actions -->
          <div class="review-actions">
            <button
              class="btn-approve"
              (click)="approve(doc)"
              [disabled]="isProcessing(doc.documentId)"
            >
              &#10003; Approve
            </button>
            <div class="reject-group">
              <input
                type="text"
                class="rejection-input"
                placeholder="Rejection reason (required to reject)"
                [value]="getRejectionReason(doc.documentId)"
                (input)="setRejectionReason(doc.documentId, $any($event.target).value)"
              />
              <button
                class="btn-reject"
                (click)="reject(doc)"
                [disabled]="isProcessing(doc.documentId)"
              >
                &#10007; Reject
              </button>
            </div>
          </div>
        </div>
      }
    </section>

    <!-- ── Processed Documents ──────────────────────────────────────────── -->
    <section class="doc-section">
      <div class="section-header">
        <h2>&#10003; Processed Documents</h2>
        <p>Documents that passed the pipeline without flags, or have been actioned by an admin.</p>
      </div>

      @if (!loading() && processed().length === 0) {
        <div class="empty-state">No processed documents yet.</div>
      }

      @if (processed().length > 0) {
        <table class="doc-table">
          <thead>
            <tr>
              <th>File</th>
              <th>Document ID</th>
              <th>Processed At</th>
              <th>Pipeline</th>
              <th>Decision</th>
              <th>Rejection Reason</th>
            </tr>
          </thead>
          <tbody>
            @for (doc of processed(); track doc.documentId) {
              <tr>
                <td>{{ doc.fileName }}</td>
                <td class="mono">{{ doc.documentId }}</td>
                <td>{{ doc.processedAt | date: 'short' }}</td>
                <td>
                  <span [class.badge-ok]="doc.overallSuccess" [class.badge-warn]="!doc.overallSuccess">
                    {{ doc.overallSuccess ? 'OK' : 'Errors' }}
                  </span>
                </td>
                <td>
                  @if (doc.reviewDecision) {
                    <span
                      [class.badge-ok]="doc.reviewDecision.approved"
                      [class.badge-reject]="!doc.reviewDecision.approved"
                    >
                      {{ doc.reviewDecision.approved ? 'Approved' : 'Rejected' }}
                    </span>
                  } @else {
                    <span class="badge-auto">Auto-passed</span>
                  }
                </td>
                <td class="detail">{{ doc.reviewDecision?.rejectionReason ?? '–' }}</td>
              </tr>
            }
          </tbody>
        </table>
      }
    </section>

  </main>
</div>
